#!/bin/bash

#############################################################################
#Script Name	: RunMapReduceShell.sh
#Description	: To Compile, Run, Push and Pull Mapreduce Job and Results
#Args         :
#Author       : Darshankumar Gorasiya
#Email        : x18134751@student.ncirl.ie
#############################################################################

# Making Hadoop Libs Available to Mapper and Reducer jobs for executing and extending on it.
export CLASSPATH="$HADOOP_HOME/lib/*:$HADOOP_HOME/share/hadoop/common/hadoop-common-2.9.2.jar:$HADOOP_HOME/share/hadoop/common/hadoop-common-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/common/hadoop-nfs-2.9.2.jar:$HADOOP_HOME/share/hadoop/common/lib/*:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-2.9.2.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-client-2.9.2.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-client-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-native-client-2.9.2.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-native-client-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-nfs-2.9.2.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-rbf-2.9.2.jar:$HADOOP_HOME/share/hadoop/hdfs/hadoop-hdfs-rbf-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/hdfs/lib/*:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-app-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-hs-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-2.9.2-tests.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-common-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-hs-plugins-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-shuffle-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-core-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-client-jobclient-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.9.2.jar:$HADOOP_HOME/share/hadoop/mapreduce/lib/*:$HADOOP_HOME/share/hadoop/tools/lib/*:$HADOOP_HOME/share/hadoop/yarn/lib/*:$HADOOP_HOME/share/hadoop/yarn/hadoop-yarn-common-2.9.2.jar:$HADOOP_HOME/share/hadoop/yarn/hadoop-yarn-server-common-2.9.2.jar:$HADOOP_HOME/share/hadoop/yarn/hadoop-yarn-client-2.9.2.jar"

WRKNG_DIR='/home/hduser/project'
PRJ_NAM='mapreduce_task2'
DRVR_CLS='HWDeviceFamDriver'

PRJ_PTH=${WRKNG_DIR}/${PRJ_NAM}
OUTPUT_PTH=${PRJ_PTH}/'output_'${PRJ_NAM}
PWD=${PRJ_PTH}

javac -d ${PRJ_PTH} ${PRJ_PTH}/*.java

echo ">>> Java Compilation Done!"

echo "Main-Class: "${DRVR_CLS} > ${PRJ_PTH}/Manifest.txt

cd ${PRJ_PTH}
jar cfm ${PRJ_NAM}.jar Manifest.txt *.class

echo ">>> if output file present in HDFS then removing!!"
hadoop fs -test -d /'output_'${PRJ_NAM}
tmp_resp=$?
if [ ${tmp_resp} -eq 0 ]; then hdfs dfs -rm -r /'output_'${PRJ_NAM}; fi

echo ">>> Map Reduce Job Starting..!"
hadoop jar ${PRJ_PTH}/${PRJ_NAM}.jar /pda/malware_prediction /'output_'${PRJ_NAM}

echo ">>> Copy to Local From HDFS"

if [ -d ${OUTPUT_PTH} ]; then rm -rf ${OUTPUT_PTH}; fi
mkdir ${OUTPUT_PTH}
hdfs dfs -copyToLocal /'output_'${PRJ_NAM}/* ${OUTPUT_PTH}

echo ">>> Copy to Local Done! "/"output_"${PRJ_NAM}
